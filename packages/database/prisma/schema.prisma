// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())

  name              String?
  email             String   @unique
  emailVerified     Boolean? @default(false)
  image             String?
  phone             String?
  isNewUser         Boolean  @default(true)
  role              String   @default("User")
  isVerifiedStudent Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student  Student?
  sessions Session[]
  accounts Account[]

  @@index([createdAt])
  @@index([name])
  @@index([phone])
}

model Session {
  id String @id @default(uuid())

  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id String @id @default(uuid())

  userId     String
  accountId  String
  providerId String

  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?   @db.Text
  password              String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String   @unique
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([identifier, value])
}

model SmsVerification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@index([identifier, expiresAt])
  @@index([value])
}

model ClassName {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students Student[]
  batches  Batch[]
  exams    ExamClassName[]
}

model Institute {
  id   String @id @default(uuid())
  name String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students Student[]

  @@unique([name])
}

model Student {
  id          String   @id @default(uuid())
  studentId   String
  name        String
  nameBangla  String
  fName       String
  mName       String
  gender      String
  dob         DateTime
  nationality String
  religion    String
  imageUrl    String?

  section String?
  shift   String
  group   String
  roll    String

  fPhone String
  mPhone String

  presentHouseNo    String
  presentMoholla    String
  presentPost       String
  presentThana      String
  permanentVillage  String
  permanentPost     String
  permanentThana    String
  permanentDistrict String

  studentStatus StudentStatus?

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  instituteId String
  institute   Institute @relation(fields: [instituteId], references: [id], onDelete: Restrict)

  classNameId String
  className   ClassName @relation(fields: [classNameId], references: [id], onDelete: Restrict)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  exams ExamStudent[]

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  attempts  ExamAttempt[]

  @@index([instituteId])
  @@index([classNameId])
  @@index([studentId])
  @@index([name])
  @@index([roll])
}

model StudentStatus {
  id           String    @id @default(uuid())
  status       String    @default("Present")
  absentReason String?
  absentDate   DateTime?

  studentId String  @unique
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([absentDate])
}

model Subject {
  id    String @id @default(uuid())
  name  String
  level String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chapters Chapter[]
  mcqs     Mcq[]
  exams    ExamSubject[]

  @@index([name])
  @@index([level])
}

model Chapter {
  id       String @id @default(uuid())
  name     String
  position Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  mcqs  Mcq[]
  exams ExamChapter[]

  @@index([subjectId])
  @@index([name])
  @@index([subjectId, name])
}

model Mcq {
  id          String   @id @default(uuid())
  question    String
  options     String[]
  statements  String[] @default([])
  answer      String
  type        String
  reference   String[] @default([])
  explanation String?
  isMath      Boolean  @default(false)
  session     Int
  source      String?
  questionUrl String?
  context     String?
  contextUrl  String?

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  chapterId String
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Restrict)

  exams ExamMcq[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  answerHistories AnswerHistory[]

  @@index([subjectId])
  @@index([chapterId])
  @@index([type])
  @@index([session])
  @@index([isMath])
  @@index([subjectId, chapterId])
  @@index([subjectId, type])
  @@index([chapterId, type])
  @@index([type, session])
}

model Batch {
  id   String @id @default(uuid())
  name String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  classNameId String
  className   ClassName @relation(fields: [classNameId], references: [id], onDelete: Restrict)

  students Student[]
  exams    ExamBatch[]

  @@unique([classNameId, name])
  @@index([classNameId])
}

model Exam {
  id              String   @id @default(uuid())
  title           String
  total           Int
  duration        Int
  cq              Int?
  mcq             Int?
  startDate       DateTime
  endDate         DateTime
  hasSuffle       Boolean  @default(false)
  hasRandom       Boolean  @default(false)
  hasNegativeMark Boolean  @default(false)
  negativeMark    Float    @default(0)
  type            String

  status String @default("Pending")

  subjects   ExamSubject[]
  batches    ExamBatch[]
  classNames ExamClassName[]
  students   ExamStudent[]
  mcqs       ExamMcq[]
  attempts   ExamAttempt[]
  chapters   ExamChapter[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
}

model ExamChapter {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  chapterId String
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examId])
  @@index([chapterId])
}

model ExamBatch {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examId])
  @@index([batchId])
}

model ExamClassName {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  classNameId String
  className   ClassName @relation(fields: [classNameId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examId])
  @@index([classNameId])
}

model ExamStudent {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examId])
  @@index([studentId])
}

model ExamSubject {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examId])
  @@index([subjectId])
}

model ExamMcq {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  mcqId String
  mcq   Mcq    @relation(fields: [mcqId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examId])
  @@index([mcqId])
}

// ============================================
// IMPROVED EXAM ATTEMPT MODEL
// ============================================
model ExamAttempt {
  id   String @id @default(uuid())
  type String

  // Answer tracking - store detailed answer information as JSON
  // Format: [{mcqId, selectedOption, isCorrect, answeredAt, timeSpent}]
  answers Json[] @default([])

  // Performance metrics - denormalized for fast queries
  score            Float @default(0)
  correctAnswers   Int   @default(0)
  wrongAnswers     Int   @default(0)
  skippedQuestions Int   @default(0)

  // Streak tracking for gamification
  currentStreak Int @default(0)
  bestStreak    Int @default(0)

  // Timing information
  startTime      DateTime?
  endTime        DateTime?
  duration       Int?      @default(0) // Total duration in seconds
  lastActivityAt DateTime? // Last time user interacted (for monitoring)

  // Question management
  totalQuestions   Int // Total questions at attempt start
  answeredCount    Int   @default(0) // Denormalized count
  flaggedQuestions Int[] @default([])

  // Exam status and behavior
  status         String  @default("Not Started") // Not Started, In Progress, Submitted, Auto-Submitted, Abandoned
  submissionType String? // Manual, Auto-TimeUp, Auto-TabSwitch

  // Features and settings - snapshot at attempt creation
  enableAiFeature Boolean @default(false)
  hasNegativeMark Boolean @default(false) // Copy from exam at creation
  negativeMark    Float   @default(0) // Copy from exam at creation
  hasShuffle      Boolean @default(false)
  hasRandom       Boolean @default(false)

  // Anti-cheat tracking
  tabSwitches    Int        @default(0)
  tabSwitchTimes DateTime[] @default([])
  warnings       Json[]     @default([]) // Store warning events

  // Feedback and review
  feedbackStatus String  @default("Pending") // Pending, Reviewed, Resolved
  reviewNotes    String? // Admin notes

  // Relations
  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  answerHistory AnswerHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for performance
  @@index([studentId])
  @@index([examId])
  @@index([status])
  @@index([score])
  @@index([createdAt])
  @@index([studentId, examId])
  @@index([studentId, status])
  @@index([studentId, createdAt])
  @@index([examId, status])
  @@index([status, createdAt])
  @@index([studentId, score])
  @@index([lastActivityAt])
  @@index([submissionType])
  @@index([bestStreak])
}

// ============================================
// ANSWER HISTORY MODEL (OPTIONAL BUT RECOMMENDED)
// ============================================
// Stores individual answer records for detailed analytics
model AnswerHistory {
  id String @id @default(uuid())

  attemptId String
  attempt   ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  mcqId          String
  mcq            Mcq    @relation(fields: [mcqId], references: [id], onDelete: Cascade)
  questionNumber Int // Position in exam

  // Answer details
  selectedOption String
  correctAnswer  String
  isCorrect      Boolean

  // Timing
  answeredAt DateTime @default(now())
  timeSpent  Int? // Seconds spent on this question

  // Change tracking (if you allow answer changes)
  previousAnswer String?
  isChanged      Boolean @default(false)
  changeCount    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([attemptId])
  @@index([mcqId])
  @@index([attemptId, questionNumber])
  @@index([answeredAt])
  @@index([isCorrect])
}
